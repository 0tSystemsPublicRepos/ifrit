<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFRIT Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="bg-gray-950 text-gray-100">
    <!-- Authentication Section -->
    <div id="authSection" style="display: none;" class="min-h-screen flex items-center justify-center bg-gray-950 p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-8 max-w-md w-full">
            <div class="mb-6">
                <h1 class="text-3xl font-bold bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent mb-2">
                    IFRIT Dashboard
                </h1>
                <p class="text-gray-400 text-sm">Enter your API token to access the dashboard</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">API Token</label>
                    <input 
                        type="password" 
                        id="tokenInput" 
                        placeholder="Enter your API token from config" 
                        class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded text-white placeholder-gray-500 focus:outline-none focus:border-orange-500"
                    />
                    <p class="text-xs text-gray-500 mt-2">Find this in your IFRIT config under api.token or set IFRIT_API_TOKEN env var</p>
                </div>
                
                <button 
                    onclick="setToken()" 
                    class="w-full bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-semibold py-2 rounded transition"
                >
                    Connect
                </button>
            </div>

            <div class="mt-6 p-4 bg-gray-800/50 rounded border border-gray-700">
                <p class="text-xs text-gray-400">
                    <strong>Note:</strong> Token is stored locally in your browser. Never shared with third parties.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="app" style="display: none;" class="p-6">
        <!-- Header -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent">
                        IFRIT Dashboard
                    </h1>
                </div>
                <p class="text-gray-400">Intelligent Threat Deception Platform - Real-time Attack Monitoring</p>
            </div>
            <button 
                onclick="logout()" 
                class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded text-sm transition"
            >
                Logout
            </button>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-red-500/10 border border-gray-700 rounded-lg p-6">
                <p class="text-gray-400 text-sm mb-1">Total Attacks</p>
                <p class="text-3xl font-bold text-red-500" id="totalAttacks">0</p>
            </div>
            <div class="bg-orange-500/10 border border-gray-700 rounded-lg p-6">
                <p class="text-gray-400 text-sm mb-1">Unique Attackers</p>
                <p class="text-3xl font-bold text-orange-500" id="totalAttackers">0</p>
            </div>
            <div class="bg-green-500/10 border border-gray-700 rounded-lg p-6">
                <p class="text-gray-400 text-sm mb-1">Detection Rate</p>
                <p class="text-3xl font-bold text-green-500" id="detectionRate">0%</p>
            </div>
        </div>

        <!-- Detection Stages -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-8">
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-500 w-12 h-12 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold">S1</span>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Local Rules</p>
                        <p class="text-2xl font-bold" id="stage2">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-4">
                    <div class="bg-purple-500 w-12 h-12 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold">S2</span>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Database Patterns</p>
                        <p class="text-2xl font-bold" id="stage3">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-4">
                    <div class="bg-pink-500 w-12 h-12 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold">S3</span>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">LLM Analysis</p>
                        <p class="text-2xl font-bold" id="stage4">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Attacks Table -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Recent Attacks</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="border-b border-gray-700">
                        <tr>
                            <th class="text-left py-2 px-4">Time</th>
                            <th class="text-left py-2 px-4">Attacker IP</th>
                            <th class="text-left py-2 px-4">Attack Type</th>
                            <th class="text-left py-2 px-4">Path</th>
                            <th class="text-left py-2 px-4">Method</th>
                        </tr>
                    </thead>
                    <tbody id="attacksTable">
                        <tr>
                            <td colspan="5" class="text-center py-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Attackers -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">Top Attackers</h2>
            <div class="space-y-3" id="attackersList">
                <div class="text-center py-4 text-gray-500">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8443';
        let apiToken = null;
        let isAuthenticated = false;

        // Get API token from config or localStorage
        async function initializeDashboard() {
            // Try to get token from localStorage (set by user)
            const storedToken = localStorage.getItem('ifrit_api_token');
            if (storedToken) {
                apiToken = storedToken;
                isAuthenticated = true;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                fetchData();
                setInterval(fetchData, 5000);
                return;
            }

            // Show auth section
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        function setToken() {
            const tokenInput = document.getElementById('tokenInput');
            apiToken = tokenInput.value.trim();
            
            if (!apiToken) {
                alert('Please enter your API token');
                return;
            }

            // Store token in localStorage
            localStorage.setItem('ifrit_api_token', apiToken);
            isAuthenticated = true;

            document.getElementById('authSection').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            fetchData();
            setInterval(fetchData, 5000);
        }

        function logout() {
            localStorage.removeItem('ifrit_api_token');
            apiToken = null;
            isAuthenticated = false;
            location.reload();
        }

        async function fetchWithAuth(url) {
            const headers = {
                'Content-Type': 'application/json'
            };

            if (apiToken) {
                headers['Authorization'] = `Bearer ${apiToken}`;
            }

            try {
                const response = await fetch(url, { headers });
                
                if (response.status === 401) {
                    alert('Invalid API token');
                    logout();
                    return null;
                }

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        async function fetchData() {
            try {
                // Get attacks
                const attacks = await fetchWithAuth(`${API_BASE}/api/attacks?limit=100`);
                if (!attacks) {
                    document.getElementById('attacksTable').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Connection error - check API endpoint</td></tr>';
                    return;
                }

                // Get attackers
                const attackers = await fetchWithAuth(`${API_BASE}/api/attackers`);

                // Update stats
                const stage1 = attacks.filter(a => a.detection_stage === 1).length;
                const stage2 = attacks.filter(a => a.detection_stage === 2).length;
                const stage3 = attacks.filter(a => a.detection_stage === 3).length;

                document.getElementById('totalAttacks').textContent = attacks.length;
                document.getElementById('totalAttackers').textContent = attackers ? attackers.length : 0;
                document.getElementById('detectionRate').textContent = '100%';
                document.getElementById('stage2').textContent = stage1;
                document.getElementById('stage3').textContent = stage2;
                document.getElementById('stage4').textContent = stage3;

                // Update attacks table
                const attacksTable = document.getElementById('attacksTable');
                if (attacks && attacks.length > 0) {
                    attacksTable.innerHTML = attacks.slice(0, 10).map(attack => `
                        <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition">
                            <td class="py-2 px-4 text-gray-400">${new Date(attack.timestamp).toLocaleTimeString()}</td>
                            <td class="py-2 px-4 font-mono text-orange-400">${attack.source_ip}</td>
                            <td class="py-2 px-4">
                                <span class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs font-semibold">
                                    ${attack.attack_type}
                                </span>
                            </td>
                            <td class="py-2 px-4 text-gray-300">${attack.requested_path}</td>
                            <td class="py-2 px-4 text-gray-400">${attack.http_method}</td>
                        </tr>
                    `).join('');
                } else {
                    attacksTable.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No attacks detected yet</td></tr>';
                }

                // Update attackers list
                const attackersList = document.getElementById('attackersList');
                if (attackers && attackers.length > 0) {
                    attackersList.innerHTML = attackers.slice(0, 5).map(attacker => `
                        <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded border border-gray-700">
                            <div class="flex-1">
                                <p class="font-mono text-orange-400">${attacker.source_ip}</p>
                                <p class="text-xs text-gray-400">${attacker.attack_types || 'Multiple types'}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-red-400">${attacker.total_requests} attacks</p>
                                <p class="text-xs text-gray-400">Last: ${new Date(attacker.last_seen).toLocaleTimeString()}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    attackersList.innerHTML = '<div class="text-center py-4 text-gray-500">No attackers yet</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('attacksTable').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        // Initialize on page load
        window.addEventListener('load', initializeDashboard);
    </script>
</body>
</html>
